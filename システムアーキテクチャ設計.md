# システムアーキテクチャの設計

## 1. アーキテクチャの概要

**アーキテクチャパターン**: クリーンアーキテクチャとMVVMパターンを組み合わせた設計

- **プレゼンテーション層**: UI、ユーザー入力処理、ビューモデル
- **ドメイン層**: ビジネスロジック、エンティティ、ユースケース
- **データ層**: リポジトリ、データソース、外部サービス連携

## 2. 技術スタック

### メインフレームワーク
- **プログラミング言語**: Python
- **GUIフレームワーク**: PyQt6 または PySide6
- **スタイリング**: Qtスタイルシート（QSS）

### バックエンド
- **画像処理**: OpenCV, PIL/Pillow
- **機械学習フレームワーク**: TensorFlow/Keras
- **動画処理**: FFmpeg-python

### データ管理
- **メタデータDB**: SQLite
- **キャッシュ**: Python標準ライブラリ (pickle/shelve)
- **ファイル処理**: Python os/pathlib
- **設定管理**: JSON/YAML

## 3. コンポーネント構成

### 3.1 コアコンポーネント

**1. 画像表示エンジン**
- 画像のロード・キャッシュ・表示
- ズーム・回転・パン操作
- 画像メタデータの表示
- 動画(MP4)表示とフレーム抽出

**2. ファイルシステム管理**
- ファイル・フォルダのスキャン
- サムネイル生成と管理
- ファイル操作（移動・コピー・削除）
- メタデータの抽出・保存

**3. 画像分類エンジン**
- 分類モデルの実行環境
- モデル管理（ロード・アンロード）
- バッチ処理機能
- 分類結果のキャッシュ

**4. データベース管理**
- メタデータ保存・検索
- タグ管理
- 分類結果の保存・更新
- 設定の管理

**5. UI管理**
- インターフェース表示
- ユーザー入力処理
- テーマ管理
- レイアウト制御

### 3.2 追加コンポーネント

**1. 分類モデルマネージャー**
- 複数モデルの管理
- モデルの組み合わせ・統合処理
- カスタムタグフィルタリング
- 分類基準の管理

**2. キャラクター識別モジュール**
- キャラクター識別モデル
- 画像タギングシステム
- タグベースフィルタリング
- カスタムタグの追加・編集

**3. セキュリティ管理**
- コンテンツフィルタリング
- 表示制御機能
- NSFWコンテンツの分離管理

**4. プラグイン管理**
- プラグインローダー
- プラグインAPI
- カスタムモデル連携
- 機能拡張フック

## 4. データフロー

### 1. 画像読み込みフロー
```
ユーザー操作 → ファイルシステム管理 → 画像表示エンジン → UI表示
                  ↓
               メタデータ抽出 → データベース管理
```

### 2. 画像分類フロー
```
画像データ → 前処理 → 分類モデル実行 → 結果統合 → 分類結果の保存
                        ↓
                     複数モデル
                     (NSFW検出、タグ付け、キャラクター識別)
```

### 3. 表示・操作フロー
```
UI入力 → ビューモデル → ユースケース → ドメインモデル → リポジトリ → データソース
  ↑                                                           ↓
  └────────────────── 表示更新 ←────────────────────────────┘
```

## 5. 依存関係

**フロントエンド依存**:
- Python 3.x
- PyQt6/PySide6
- Qtデザイナーツール

**バックエンド依存**:
- OpenCV
- TensorFlow/Keras
- Pillow
- NumPy/SciPy
- Pandas
- SQLite ドライバー

**機械学習モデル依存**:
- NSFW 分類モデル (GantMan/nsfw_modelベース)
- Danbooru Tagger
- DeepDanbooru
- カスタム分類モデル

## 6. スケーラビリティと拡張性

**プラグインアーキテクチャ**:
- 新しい分類モデルの追加
- カスタムビューアーの実装
- 外部サービス連携

**分離されたコンポーネント**:
- UI と ロジックの分離
- モデルとデータアクセスの分離
- プラットフォーム依存コードの隔離

**将来的な拡張**:
- クラウド連携
- 分散処理対応
- 新しいメディア形式サポート

## 7. 配置ビュー

**シングルマシン配置**:
- **アプリケーション層**: Pythonアプリケーション（PyQt6/PySide6ベース）
- **処理層**: Pythonバックエンド（画像処理、機械学習）
- **データ層**: ローカルファイルシステム、SQLiteデータベース
- **モデル層**: ローカルに保存された機械学習モデル